

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>api &mdash; t4clinical_base 1.0.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="t4clinical_base 1.0.0 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">t4clinical_base 1.0.0 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for api</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">openerp.osv</span> <span class="kn">import</span> <span class="n">orm</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">osv</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span> <span class="k">as</span> <span class="n">dt</span>
<span class="kn">from</span> <span class="nn">dateutil.relativedelta</span> <span class="kn">import</span> <span class="n">relativedelta</span> <span class="k">as</span> <span class="n">rd</span>
<span class="kn">from</span> <span class="nn">openerp</span> <span class="kn">import</span> <span class="n">SUPERUSER_ID</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span> <span class="k">as</span> <span class="n">pp</span>

<span class="kn">import</span> <span class="nn">logging</span>        
<span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Currently the target for this API is:</span>

<span class="sd">API consists of 3 classes of methods:</span>
<span class="sd">    1. &lt;object&gt;_map</span>
<span class="sd">    2. get_&lt;object&gt;s</span>
<span class="sd">    3. &lt;action&gt;[_&lt;action&gt; or _activity]</span>

<span class="sd">    1. &lt;object&gt;_map:</span>
<span class="sd">        accepts arguments in the way of lists representing positive condition of relation to the list items</span>
<span class="sd">        example: api.patient_map(cr, uid, </span>
<span class="sd">                                    patient_ids=patient_ids, </span>
<span class="sd">                                    parent_location_ids=[env.pos_id.location_id.id], </span>
<span class="sd">                                    pos_ids=[env.pos_id.id])</span>
<span class="sd">        currently following methods of this class exist:</span>
<span class="sd">            - location_map</span>
<span class="sd">            - patient_map</span>
<span class="sd">            - user_map</span>
<span class="sd">            - activity_map</span>
<span class="sd">            TODO: pos_map, device_map</span>
<span class="sd">    </span>
<span class="sd">    2. get_&lt;object&gt;s</span>
<span class="sd">        wrappers of class(1) returning either ids or browse_list depend on return_id flag value (default=False)</span>
<span class="sd">        arguments concept is the same as in class(1)</span>
<span class="sd">        currently following methods of this class exist:</span>
<span class="sd">            - get_activities</span>
<span class="sd">            - get_locations</span>
<span class="sd">            - get_patients</span>
<span class="sd">            TODO: get_users, get_poss, get_devices</span>
<span class="sd">            </span>
<span class="sd">    3. &lt;action&gt;[_&lt;action&gt; or _activity]</span>
<span class="sd">        actions on activities</span>
<span class="sd">        this class can be divided further into 3 subclasses:</span>
<span class="sd">            3.1 ORM actions</span>
<span class="sd">            3.2 single actions</span>
<span class="sd">            3.3 combined actions</span>
<span class="sd">            </span>
<span class="sd">            3.1 ORM actions</span>
<span class="sd">                this subclass represents ORM shortcuts accessible via API model</span>
<span class="sd">                currently following methods of this class exist:</span>
<span class="sd">                    - write_activity</span>
<span class="sd">                    - create_activity</span>
<span class="sd">           3.2 single actions</span>
<span class="sd">               activity action shortcuts accessible via API model</span>
<span class="sd">               currently following methods of this class exist:</span>
<span class="sd">                   - assign</span>
<span class="sd">                   - cancel</span>
<span class="sd">                   - complete</span>
<span class="sd">                   - start</span>
<span class="sd">                   - submit</span>
<span class="sd">                   - unassign</span>
<span class="sd">            3.3 combined actions</span>
<span class="sd">                combined activity action helpers</span>
<span class="sd">                currently following methods of this class exist:</span>
<span class="sd">                    - create_complete</span>
<span class="sd">                    - submit_complete</span>
<span class="sd">&quot;&quot;&quot;</span>


    
<div class="viewcode-block" id="t4_clinical_api"><a class="viewcode-back" href="../code.html#api.t4_clinical_api">[docs]</a><span class="k">class</span> <span class="nc">t4_clinical_api</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">AbstractModel</span><span class="p">):</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s">&#39;t4.clinical.api&#39;</span>
    
    <span class="k">def</span> <span class="nf">get_activity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">,</span> <span class="n">return_id</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">activity_pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="s">&#39;t4.activity&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">return_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">activity_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">activity_pool</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">)</span>
                
    <span class="k">def</span> <span class="nf">create_activity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">data_model</span><span class="p">,</span> <span class="n">vals_activity</span><span class="p">,</span> <span class="n">vals_data</span><span class="p">,</span> <span class="n">return_id</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">activity_pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="s">&#39;t4.activity&#39;</span><span class="p">]</span>
        <span class="n">data_pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="n">data_model</span><span class="p">]</span>        
        <span class="n">activity_id</span> <span class="o">=</span> <span class="n">data_pool</span><span class="o">.</span><span class="n">create_activity</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">vals_activity</span><span class="p">,</span> <span class="n">vals_data</span><span class="p">)</span>        
        <span class="k">if</span> <span class="n">return_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">activity_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">activity_pool</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">)</span>        

    <span class="k">def</span> <span class="nf">write_activity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">,</span> <span class="n">vals_activity</span><span class="p">,</span> <span class="n">return_id</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">activity_pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="s">&#39;t4.activity&#39;</span><span class="p">]</span>
        <span class="n">activity_pool</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">,</span> <span class="n">vals_activity</span><span class="p">)</span>        
        <span class="k">if</span> <span class="n">return_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">activity_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">activity_pool</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">)</span> 

    <span class="k">def</span> <span class="nf">create_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">data_model</span><span class="p">,</span> <span class="n">activity_vals</span><span class="o">=</span><span class="p">{},</span> <span class="n">data_vals</span><span class="o">=</span><span class="p">{},</span> <span class="n">return_id</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">data_pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="n">data_model</span><span class="p">]</span>
        <span class="n">activity_pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="s">&#39;t4.activity&#39;</span><span class="p">]</span>
        <span class="n">activity_id</span> <span class="o">=</span> <span class="n">data_pool</span><span class="o">.</span><span class="n">create_activity</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_vals</span><span class="p">,</span> <span class="n">data_vals</span><span class="p">)</span>
        <span class="n">activity_pool</span><span class="o">.</span><span class="n">complete</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">)</span>       
        <span class="k">if</span> <span class="n">return_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">activity_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">activity_pool</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">submit_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">,</span> <span class="n">data_vals</span><span class="o">=</span><span class="p">{},</span> <span class="n">return_id</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">activity_pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="s">&#39;t4.activity&#39;</span><span class="p">]</span>
        <span class="n">activity_pool</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">,</span> <span class="n">data_vals</span><span class="p">)</span>
        <span class="n">activity_pool</span><span class="o">.</span><span class="n">complete</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">)</span>       
        <span class="k">if</span> <span class="n">return_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">activity_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">activity_pool</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">,</span> <span class="n">date_scheduled</span><span class="p">,</span> <span class="n">return_id</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">activity_pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="s">&#39;t4.activity&#39;</span><span class="p">]</span>
        <span class="n">activity_pool</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">,</span> <span class="n">date_scheduled</span><span class="p">)</span>        
        <span class="k">if</span> <span class="n">return_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">activity_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">activity_pool</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">)</span>     
            
    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">,</span> <span class="n">return_id</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">activity_pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="s">&#39;t4.activity&#39;</span><span class="p">]</span>
        <span class="n">activity_pool</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">)</span>        
        <span class="k">if</span> <span class="n">return_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">activity_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">activity_pool</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">)</span>       
    
    <span class="k">def</span> <span class="nf">complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">,</span> <span class="n">return_id</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">activity_pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="s">&#39;t4.activity&#39;</span><span class="p">]</span>
        <span class="n">activity_pool</span><span class="o">.</span><span class="n">complete</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">)</span>        
        <span class="k">if</span> <span class="n">return_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">activity_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">activity_pool</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">)</span> 
    
    <span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">,</span> <span class="n">return_id</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">activity_pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="s">&#39;t4.activity&#39;</span><span class="p">]</span>
        <span class="n">activity_pool</span><span class="o">.</span><span class="n">cancel</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">)</span>        
        <span class="k">if</span> <span class="n">return_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">activity_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">activity_pool</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">)</span> 

    <span class="k">def</span> <span class="nf">submit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">,</span> <span class="n">vals_data</span><span class="p">,</span> <span class="n">return_id</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">activity_pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="s">&#39;t4.activity&#39;</span><span class="p">]</span>
        <span class="n">activity_pool</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">,</span> <span class="n">vals_data</span><span class="p">)</span>        
        <span class="k">if</span> <span class="n">return_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">activity_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">activity_pool</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">)</span> 
    
    <span class="k">def</span> <span class="nf">assign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">return_id</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">activity_pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="s">&#39;t4.activity&#39;</span><span class="p">]</span>
        <span class="n">activity_pool</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>        
        <span class="k">if</span> <span class="n">return_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">activity_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">activity_pool</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">)</span> 
    
    <span class="k">def</span> <span class="nf">unassign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">,</span> <span class="n">return_id</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">activity_pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="s">&#39;t4.activity&#39;</span><span class="p">]</span>
        <span class="n">activity_pool</span><span class="o">.</span><span class="n">unassign</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">)</span>        
        <span class="k">if</span> <span class="n">return_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">activity_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">activity_pool</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">)</span> 

<div class="viewcode-block" id="t4_clinical_api.activity_info"><a class="viewcode-back" href="../code.html#api.t4_clinical_api.activity_info">[docs]</a>    <span class="k">def</span> <span class="nf">activity_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            activity diagnostic info</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">activity_pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="s">&#39;t4.activity&#39;</span><span class="p">]</span>
        <span class="n">activity</span> <span class="o">=</span> <span class="n">activity_pool</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">res</span><span class="p">[</span><span class="s">&#39;activity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">activity_pool</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span><span class="n">uid</span><span class="p">,</span><span class="n">activity_id</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">res</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="n">activity</span><span class="o">.</span><span class="n">data_model</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span><span class="n">uid</span><span class="p">,</span><span class="n">activity</span><span class="o">.</span><span class="n">data_ref</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">res</span><span class="p">[</span><span class="s">&#39;parents&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">activity</span><span class="o">.</span><span class="n">parent_id</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">parent</span><span class="p">:</span> <span class="k">break</span>
            <span class="n">activity</span> <span class="o">=</span> <span class="n">activity</span> <span class="o">=</span> <span class="n">activity_pool</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">parent</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="n">res</span><span class="p">[</span><span class="s">&#39;parents&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">parent</span><span class="o">.</span><span class="n">data_model</span><span class="p">:</span> <span class="n">parent</span><span class="p">})</span>
        <span class="n">res</span><span class="p">[</span><span class="s">&#39;creators&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">activity</span> <span class="o">=</span> <span class="n">activity_pool</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">creator</span> <span class="o">=</span> <span class="n">activity</span><span class="o">.</span><span class="n">creator_id</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">creator</span><span class="p">:</span> <span class="k">break</span>
            <span class="n">activity</span> <span class="o">=</span> <span class="n">activity_pool</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">creator</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="n">res</span><span class="p">[</span><span class="s">&#39;creators&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">creator</span><span class="o">.</span><span class="n">data_model</span><span class="p">:</span> <span class="n">creator</span><span class="p">})</span> 
        <span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span> <span class="k">as</span> <span class="n">pp</span>
        <span class="n">pp</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>       
</div>
    <span class="k">def</span> <span class="nf">get_patients</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">patient_ids</span><span class="o">=</span><span class="p">[],</span> <span class="n">pos_ids</span><span class="o">=</span><span class="p">[],</span> <span class="n">location_ids</span><span class="o">=</span><span class="p">[],</span> <span class="n">parent_location_ids</span><span class="o">=</span><span class="p">[],</span> <span class="n">return_id</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">patient_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> 
                                       <span class="n">patient_ids</span><span class="o">=</span><span class="n">patient_ids</span><span class="p">,</span> 
                                       <span class="n">pos_ids</span><span class="o">=</span><span class="n">pos_ids</span><span class="p">,</span>
                                       <span class="n">location_ids</span><span class="o">=</span><span class="n">location_ids</span><span class="p">,</span>
                                       <span class="n">parent_location_ids</span><span class="o">=</span><span class="n">parent_location_ids</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">return_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">patient_ids</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="s">&#39;t4.clinical.patient&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">brpwse</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">patient_ids</span><span class="p">)</span>
        

<div class="viewcode-block" id="t4_clinical_api.patient_map"><a class="viewcode-back" href="../code.html#api.t4_clinical_api.patient_map">[docs]</a>    <span class="k">def</span> <span class="nf">patient_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">patient_ids</span><span class="o">=</span><span class="p">[],</span> <span class="n">pos_ids</span><span class="o">=</span><span class="p">[],</span> <span class="n">location_ids</span><span class="o">=</span><span class="p">[],</span> <span class="n">parent_location_ids</span><span class="o">=</span><span class="p">[]):</span>  
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Arguments and Return Parameters may be extended at later stages</span>
<span class="sd">        Returns:</span>
<span class="sd">            Description: user data, real and calculated parameters</span>
<span class="sd">            Format: {id: {id, ..., other params}}</span>
<span class="sd">            Parameters:</span>
<span class="sd">                id: t4.clinical.patient field</span>
<span class="sd">                location_id: patient&#39;s current location </span>
<span class="sd">                pos_id: patient&#39;s current pos</span>
<span class="sd">                ...</span>
<span class="sd">                TODO:</span>
<span class="sd">                    route: {sequence: location_id, ...}</span>
<span class="sd">                    spell_activity_id</span>
<span class="sd">        Arguments:</span>
<span class="sd">           pos_ids=[], patient_ids=[]: unlimited lists of values semantically corresponding to the parameter name</span>
<span class="sd">           ...</span>
<span class="sd">           TODO:</span>
<span class="sd">               route_location_ids=[]: location ids that patient&#39;s route crosses</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#assert all([isinstance(id, (int, long)) and id not in (False, True) for id in patient_ids])</span>
<span class="c">#         patient_ids = [id for id in patient_ids  if id not in (False, True)]</span>
<span class="c">#         pos_ids = [id for id in pos_ids  if id not in (False, True)]</span>
        <span class="n">where_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">patient_ids</span><span class="p">:</span> <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;id in (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">patient_ids</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">pos_ids</span><span class="p">:</span> <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;pos_id in (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">pos_ids</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">location_ids</span><span class="p">:</span> <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;location_id in (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">location_ids</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">parent_location_ids</span><span class="p">:</span> <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;parent_location_ids &amp;&amp; array[</span><span class="si">%s</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">parent_location_ids</span><span class="p">]))</span>
        <span class="n">where_clause</span> <span class="o">=</span> <span class="n">where_list</span> <span class="ow">and</span> <span class="s">&quot;where </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="s">&quot; and &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">where_list</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&quot;&quot;</span>
        <span class="k">print</span> <span class="n">where_clause</span>     
        <span class="n">sql</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">with</span>
<span class="s">    location_hierarchy  as (</span>
<span class="s">        with recursive location_path(level,path,parent_id,id) as (</span>
<span class="s">            select 0, id::text, parent_id, id from t4_clinical_location where parent_id is null</span>
<span class="s">                union</span>
<span class="s">            select level + 1, path||&#39;,&#39;||l.id, l.parent_id, l.id from t4_clinical_location l join location_path on l.parent_id = location_path.id</span>
<span class="s">        )</span>
<span class="s">        select id, (&#39;{&#39;||path||&#39;}&#39;)::int[] as parent_ids </span>
<span class="s">        from location_path</span>
<span class="s">        order by path</span>
<span class="s">    ),</span>

<span class="s">    activity_parent_child_hierarchy  as (</span>
<span class="s">        with recursive activity_path(level,path,parent_id,id) as (</span>
<span class="s">            select 0, id::text, parent_id, id from t4_activity where parent_id is null</span>
<span class="s">                union</span>
<span class="s">            select level + 1, path||&#39;,&#39;||a.id, a.parent_id, a.id from t4_activity a join activity_path on a.parent_id = activity_path.id</span>
<span class="s">        )    </span>
<span class="s">        select id, (&#39;{&#39;||path||&#39;}&#39;)::int[] as parent_ids </span>
<span class="s">        from activity_path</span>
<span class="s">        order by path</span>
<span class="s">    ),</span>
<span class="s">    move_activity as (</span>
<span class="s">        select </span>
<span class="s">            a.id,</span>
<span class="s">            rank() over(partition by patient_id order by termination_seq desc),</span>
<span class="s">            patient_id,</span>
<span class="s">            location_id,</span>
<span class="s">            pos_id,</span>
<span class="s">            h.parent_ids</span>
<span class="s">        from t4_activity a </span>
<span class="s">        inner join activity_parent_child_hierarchy h on h.id = a.id</span>
<span class="s">        where data_model = &#39;t4.clinical.patient.move&#39; and state = &#39;completed&#39;</span>
<span class="s">    ),</span>
<span class="s">    spell_activity as (</span>
<span class="s">        select </span>
<span class="s">            patient_id,</span>
<span class="s">            state,</span>
<span class="s">            array_agg(id) as ids,</span>
<span class="s">            max(id) as max_id</span>
<span class="s">            </span>
<span class="s">        from t4_activity</span>
<span class="s">        where data_model = &#39;t4.clinical.spell&#39;</span>
<span class="s">        group by patient_id, state</span>
<span class="s">    )  ,</span>
<span class="s">    map as (</span>
<span class="s">        select </span>
<span class="s">            patient.id,</span>
<span class="s">            patient.family_name,</span>
<span class="s">            patient.given_name,</span>
<span class="s">            patient.middle_names,</span>
<span class="s">            patient.other_identifier,</span>
<span class="s">            patient.gender,</span>
<span class="s">            patient.dob::text,</span>
<span class="s">            extract(year from age(now(), patient.dob)) as age,</span>
<span class="s">            move_activity.location_id,</span>
<span class="s">            location_hierarchy.parent_ids as parent_location_ids,</span>
<span class="s">            spell_activity.max_id as spell_activity_id,</span>
<span class="s">            previous_spell_activity.ids as previous_spell_activity_ids,</span>
<span class="s">            pos.id as pos_id</span>
<span class="s">        from t4_clinical_patient patient</span>
<span class="s">        left join spell_activity on spell_activity.patient_id = patient.id and spell_activity.state = &#39;started&#39;</span>
<span class="s">        left join spell_activity previous_spell_activity on previous_spell_activity.patient_id = patient.id and previous_spell_activity.state != &#39;started&#39;</span>
<span class="s">        left join move_activity on move_activity.patient_id = patient.id and move_activity.rank = 1 and move_activity.parent_ids &amp;&amp; array[spell_activity.max_id]</span>
<span class="s">        left join t4_clinical_pos pos on pos.id = move_activity.pos_id</span>
<span class="s">        left join location_hierarchy on location_hierarchy.id = move_activity.location_id</span>
<span class="s">    )</span>

<span class="s">             select * from map </span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">where_clause</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="n">r</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]:</span> <span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">dictfetchall</span><span class="p">()}</span>
        <span class="c">#import pdb; pdb.set_trace()</span>
        <span class="k">return</span> <span class="n">res</span>
    </div>
<div class="viewcode-block" id="t4_clinical_api.user_map"><a class="viewcode-back" href="../code.html#api.t4_clinical_api.user_map">[docs]</a>    <span class="k">def</span> <span class="nf">user_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span><span class="n">uid</span><span class="p">,</span> <span class="n">user_ids</span><span class="o">=</span><span class="p">[],</span> <span class="n">group_xmlids</span><span class="o">=</span><span class="p">[],</span> <span class="n">assigned_activity_ids</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Arguments and Return Parameters may be extended at later stages</span>
<span class="sd">        Returns:</span>
<span class="sd">            Description: user data, real and calculated parameters</span>
<span class="sd">            Format: {id: {id, ..., other params}}</span>
<span class="sd">            Parameters:</span>
<span class="sd">                id, login: res.users fields</span>
<span class="sd">                group_xmlids: user&#39;s groups xml ids </span>
<span class="sd">                assigned_activity_ids: ids of activities assigned to the user</span>
<span class="sd">                ...</span>
<span class="sd">                TODO:</span>
<span class="sd">                    responsible_activity_ids</span>
<span class="sd">                    </span>
<span class="sd">        Arguments:</span>
<span class="sd">           user_ids=[], group_xmlids=[], assigned_activity_ids=[]: unlimited lists of values semantically corresponding to the parameter name</span>
<span class="sd">           ...</span>
<span class="sd">           TODO: </span>
<span class="sd">               responsible_activity_ids</span>
<span class="sd">           </span>
<span class="sd">                   </span>
<span class="sd">        returns:</span>
<span class="sd">        {user_id: {group_xmlids, assigned_activity_ids, responsible_activity_ids}}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">where_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">assigned_activity_ids</span><span class="p">:</span> <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;assigned_activity_ids &amp;&amp; array[</span><span class="si">%s</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">assigned_activity_ids</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">user_ids</span><span class="p">:</span> <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;user_id in (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">user_ids</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">group_xmlids</span><span class="p">:</span> <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;group_xmlids &amp;&amp; array[&#39;</span><span class="si">%s</span><span class="s">&#39;]&quot;</span> <span class="o">%</span> <span class="s">&quot;&#39;,&#39;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_xmlids</span><span class="p">))</span>
        <span class="n">where_clause</span> <span class="o">=</span> <span class="n">where_list</span> <span class="ow">and</span> <span class="s">&quot;where </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="s">&quot; and &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">where_list</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&quot;&quot;</span>       
        <span class="n">sql</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">            with </span>
<span class="s">            groups as (</span>
<span class="s">                    select </span>
<span class="s">                        gur.uid as user_id, </span>
<span class="s">                        array_agg(imd.name::text) as group_xmlids </span>
<span class="s">                    from res_groups_users_rel gur</span>
<span class="s">                    inner join res_groups g on g.id = gur.gid</span>
<span class="s">                    inner join ir_model_data imd on imd.res_id = g.id and imd.model = &#39;res.groups&#39;</span>
<span class="s">                    group by gur.uid </span>
<span class="s">            ), </span>
<span class="s">            assigned_activity as(</span>
<span class="s">                    select </span>
<span class="s">                        a.user_id,</span>
<span class="s">                        array_agg(a.id) as assigned_activity_ids</span>
<span class="s">                    from t4_activity a</span>
<span class="s">                    where user_id is not null</span>
<span class="s">                    group by a.user_id</span>
<span class="s">            ),</span>
<span class="s">            map as (</span>
<span class="s">                    select </span>
<span class="s">                        u.id,</span>
<span class="s">                        u.login as login,</span>
<span class="s">                        g.group_xmlids,</span>
<span class="s">                        aa.assigned_activity_ids</span>
<span class="s">                    from res_users u</span>
<span class="s">                    left join groups g on g.user_id = u.id</span>
<span class="s">                    left join assigned_activity aa on aa.user_id = u.id</span>
<span class="s">            )</span>
<span class="s">            select * from map</span>
<span class="s">            {where_clause}</span>
<span class="s">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">where_clause</span><span class="o">=</span><span class="n">where_clause</span><span class="p">)</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="n">r</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]:</span> <span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">dictfetchall</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">res</span>
    </div>
    <span class="k">def</span> <span class="nf">get_location_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">location_ids</span><span class="o">=</span><span class="p">[],</span> <span class="n">types</span><span class="o">=</span><span class="p">[],</span> <span class="n">usages</span><span class="o">=</span><span class="p">[],</span> <span class="n">codes</span><span class="o">=</span><span class="p">[],</span> <span class="n">pos_ids</span><span class="o">=</span><span class="p">[],</span>
                                  <span class="n">occupied_range</span><span class="o">=</span><span class="p">[],</span> <span class="n">capacity_range</span><span class="o">=</span><span class="p">[],</span> <span class="n">available_range</span><span class="o">=</span><span class="p">[]):</span>    
        <span class="n">location_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_map</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">pos_ids</span><span class="o">=</span><span class="n">pos_ids</span><span class="p">,</span>
                                  <span class="n">location_ids</span><span class="o">=</span><span class="n">location_ids</span><span class="p">,</span> <span class="n">types</span><span class="o">=</span><span class="n">types</span><span class="p">,</span> <span class="n">usages</span><span class="o">=</span><span class="n">usages</span><span class="p">,</span> <span class="n">codes</span><span class="o">=</span><span class="n">codes</span><span class="p">,</span>
                                  <span class="n">occupied_range</span><span class="o">=</span><span class="n">occupied_range</span><span class="p">,</span> <span class="n">capacity_range</span><span class="o">=</span><span class="n">capacity_range</span><span class="p">,</span> 
                                  <span class="n">available_range</span><span class="o">=</span><span class="n">available_range</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">location_ids</span>

    <span class="k">def</span> <span class="nf">get_locations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> 
                                  <span class="n">location_ids</span><span class="o">=</span><span class="p">[],</span> <span class="n">types</span><span class="o">=</span><span class="p">[],</span> <span class="n">usages</span><span class="o">=</span><span class="p">[],</span> <span class="n">codes</span><span class="o">=</span><span class="p">[],</span> <span class="n">pos_ids</span><span class="o">=</span><span class="p">[],</span>
                                  <span class="n">occupied_range</span><span class="o">=</span><span class="p">[],</span> <span class="n">capacity_range</span><span class="o">=</span><span class="p">[],</span> <span class="n">available_range</span><span class="o">=</span><span class="p">[],</span> <span class="n">return_id</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">location_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_map</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">pos_ids</span><span class="o">=</span><span class="n">pos_ids</span><span class="p">,</span>
                                  <span class="n">location_ids</span><span class="o">=</span><span class="n">location_ids</span><span class="p">,</span> <span class="n">types</span><span class="o">=</span><span class="n">types</span><span class="p">,</span> <span class="n">usages</span><span class="o">=</span><span class="n">usages</span><span class="p">,</span> <span class="n">codes</span><span class="o">=</span><span class="n">codes</span><span class="p">,</span>
                                  <span class="n">occupied_range</span><span class="o">=</span><span class="n">occupied_range</span><span class="p">,</span> <span class="n">capacity_range</span><span class="o">=</span><span class="n">capacity_range</span><span class="p">,</span> 
                                  <span class="n">available_range</span><span class="o">=</span><span class="n">available_range</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">return_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">location_ids</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="s">&#39;t4.clinical.location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">location_ids</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">activity_rank_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> 
                        <span class="n">partition_by</span><span class="o">=</span><span class="s">&quot;patient_id, state&quot;</span><span class="p">,</span> <span class="n">partition_order</span><span class="o">=</span><span class="s">&quot;termination_seq desc&quot;</span><span class="p">,</span> <span class="n">rank_order</span><span class="o">=</span><span class="s">&quot;desc&quot;</span><span class="p">,</span>
                        <span class="n">ranks</span><span class="o">=</span><span class="p">[],</span>
                        <span class="n">activity_ids</span><span class="o">=</span><span class="p">[],</span> <span class="n">pos_ids</span><span class="o">=</span><span class="p">[],</span> <span class="n">location_ids</span><span class="o">=</span><span class="p">[],</span> <span class="n">patient_ids</span><span class="o">=</span><span class="p">[],</span>
                        <span class="n">device_ids</span><span class="o">=</span><span class="p">[],</span> <span class="n">data_models</span><span class="o">=</span><span class="p">[],</span> <span class="n">states</span><span class="o">=</span><span class="p">[]):</span>
        <span class="n">where_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">activity_ids</span><span class="p">:</span> <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;id in (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">activity_ids</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">pos_ids</span><span class="p">:</span> <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;pos_id in (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">pos_ids</span><span class="p">]))</span>    
        <span class="k">if</span> <span class="n">location_ids</span><span class="p">:</span> <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;location_id in (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">location_ids</span><span class="p">]))</span> 
        <span class="k">if</span> <span class="n">patient_ids</span><span class="p">:</span> <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;patient_id in (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">patient_ids</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">device_ids</span><span class="p">:</span> <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;device_id in (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">device_ids</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">data_models</span><span class="p">:</span> <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;data_model in (&#39;</span><span class="si">%s</span><span class="s">&#39;)&quot;</span> <span class="o">%</span> <span class="s">&quot;&#39;,&#39;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_models</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">states</span><span class="p">:</span> <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;state in (&#39;</span><span class="si">%s</span><span class="s">&#39;)&quot;</span> <span class="o">%</span> <span class="s">&quot;&#39;,&#39;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">states</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ranks</span><span class="p">:</span> <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;rank in (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ranks</span><span class="p">]))</span>
        
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s">&quot;partition_by&quot;</span><span class="p">:</span> <span class="n">partition_by</span><span class="p">,</span>
          <span class="s">&quot;where&quot;</span><span class="p">:</span> <span class="n">where_list</span> <span class="ow">and</span> <span class="s">&quot;where </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="s">&quot; and &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">where_list</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
          <span class="s">&quot;partition_order&quot;</span><span class="p">:</span> <span class="n">partition_order</span>
        <span class="p">}</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">            with </span>
<span class="s">            activity as (</span>
<span class="s">                select </span>
<span class="s">                    id, </span>
<span class="s">                    pos_id,</span>
<span class="s">                    location_id,</span>
<span class="s">                    patient_id,</span>
<span class="s">                    device_id,</span>
<span class="s">                    data_model,</span>
<span class="s">                    state,</span>
<span class="s">                    rank() over (partition by {partition_by} order by {partition_order}) as rank</span>
<span class="s">                from t4_activity</span>
<span class="s">            )</span>
<span class="s">            select * from activity</span>
<span class="s">            {where}</span>
<span class="s">            &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
        <span class="k">print</span> <span class="n">sql</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="n">r</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]:</span> <span class="n">r</span><span class="p">[</span><span class="s">&#39;rank&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">dictfetchall</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">res</span> 

<div class="viewcode-block" id="t4_clinical_api.activity_map"><a class="viewcode-back" href="../code.html#api.t4_clinical_api.activity_map">[docs]</a>    <span class="k">def</span> <span class="nf">activity_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_ids</span><span class="o">=</span><span class="p">[],</span>
                       <span class="n">pos_ids</span><span class="o">=</span><span class="p">[],</span> <span class="n">location_ids</span><span class="o">=</span><span class="p">[],</span> <span class="n">patient_ids</span><span class="o">=</span><span class="p">[],</span>
                       <span class="n">device_ids</span><span class="o">=</span><span class="p">[],</span> <span class="n">data_models</span><span class="o">=</span><span class="p">[],</span> <span class="n">states</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Arguments and Return Parameters may be extended at later stages</span>
<span class="sd">        Returns:</span>
<span class="sd">            Description: user data, real and calculated parameters</span>
<span class="sd">            Format: {id: {id, ..., other params}}</span>
<span class="sd">            Parameters:</span>
<span class="sd">                id, all real fields of t4.activity: t4.clinical.patient field</span>
<span class="sd">                ...</span>
<span class="sd">                TODO:</span>
<span class="sd">                    ...</span>
<span class="sd">                    </span>
<span class="sd">        Arguments:</span>
<span class="sd">           activity_ids=[],</span>
<span class="sd">           pos_ids=[], location_ids=[], patient_ids=[],</span>
<span class="sd">           device_ids=[], data_models=[], states=[]: unlimited lists of values semantically corresponding to the parameter name</span>
<span class="sd">           ...</span>
<span class="sd">           TODO:</span>
<span class="sd">               ...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">where_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">activity_ids</span><span class="p">:</span> <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;id in (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">activity_ids</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">pos_ids</span><span class="p">:</span> <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;pos_id in (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">pos_ids</span><span class="p">]))</span>    
        <span class="k">if</span> <span class="n">location_ids</span><span class="p">:</span> <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;location_id in (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">location_ids</span><span class="p">]))</span> 
        <span class="k">if</span> <span class="n">patient_ids</span><span class="p">:</span> <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;patient_id in (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">patient_ids</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">device_ids</span><span class="p">:</span> <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;device_id in (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">device_ids</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">data_models</span><span class="p">:</span> <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;data_model in (&#39;</span><span class="si">%s</span><span class="s">&#39;)&quot;</span> <span class="o">%</span> <span class="s">&quot;&#39;,&#39;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_models</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">states</span><span class="p">:</span> <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;state in (&#39;</span><span class="si">%s</span><span class="s">&#39;)&quot;</span> <span class="o">%</span> <span class="s">&quot;&#39;,&#39;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">states</span><span class="p">))</span>
        <span class="n">where_clause</span> <span class="o">=</span> <span class="n">where_list</span> <span class="ow">and</span> <span class="s">&quot;where </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="s">&quot; and &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">where_list</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&quot;&quot;</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">        select</span>
<span class="s">            *</span>
<span class="s">        from t4_activity</span>
<span class="s">        </span>
<span class="s">        </span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">where_clause</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="c">#print sql</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="n">r</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]:</span> <span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">dictfetchall</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">res</span>
    </div>
    <span class="k">def</span> <span class="nf">get_activities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_ids</span><span class="o">=</span><span class="p">[],</span>
                       <span class="n">pos_ids</span><span class="o">=</span><span class="p">[],</span> <span class="n">location_ids</span><span class="o">=</span><span class="p">[],</span> <span class="n">patient_ids</span><span class="o">=</span><span class="p">[],</span><span class="n">device_ids</span><span class="o">=</span><span class="p">[],</span> <span class="n">data_models</span><span class="o">=</span><span class="p">[],</span> <span class="n">states</span><span class="o">=</span><span class="p">[],</span> <span class="n">return_id</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">activity_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activity_map</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">pos_ids</span><span class="o">=</span><span class="n">pos_ids</span><span class="p">,</span> <span class="n">location_ids</span><span class="o">=</span><span class="n">location_ids</span><span class="p">,</span> 
                                             <span class="n">patient_ids</span><span class="o">=</span><span class="n">patient_ids</span><span class="p">,</span> <span class="n">device_ids</span><span class="o">=</span><span class="n">device_ids</span><span class="p">,</span> 
                                             <span class="n">data_models</span><span class="o">=</span><span class="n">data_models</span><span class="p">,</span> <span class="n">states</span><span class="o">=</span><span class="n">states</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">return_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">location_ids</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="s">&#39;t4.activity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_ids</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_activity_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">):</span>
        <span class="n">activity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="s">&#39;t4.activity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity_id</span><span class="p">)</span>
        <span class="n">data_pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="n">activity</span><span class="o">.</span><span class="n">data_model</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data_pool</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">activity</span><span class="o">.</span><span class="n">data_ref</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">data_pool</span><span class="o">.</span><span class="n">_columns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">_type</span> <span class="o">==</span> <span class="s">&#39;many2one&#39;</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">):</span>
                <span class="n">data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">field_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">data</span>
        
        
<div class="viewcode-block" id="t4_clinical_api.location_map"><a class="viewcode-back" href="../code.html#api.t4_clinical_api.location_map">[docs]</a>    <span class="k">def</span> <span class="nf">location_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">location_ids</span><span class="o">=</span><span class="p">[],</span> <span class="n">types</span><span class="o">=</span><span class="p">[],</span> <span class="n">usages</span><span class="o">=</span><span class="p">[],</span> <span class="n">codes</span><span class="o">=</span><span class="p">[],</span> <span class="n">pos_ids</span><span class="o">=</span><span class="p">[],</span>
                                    <span class="n">patient_ids</span><span class="o">=</span><span class="p">[],</span> <span class="n">occupied_range</span><span class="o">=</span><span class="p">[],</span> <span class="n">capacity_range</span><span class="o">=</span><span class="p">[],</span> <span class="n">available_range</span><span class="o">=</span><span class="p">[],</span> <span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>  
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Arguments and Return Parameters may be extended at later stages</span>
<span class="sd">        Returns:</span>
<span class="sd">            Description: location data, real and calculated parameters</span>
<span class="sd">            Format: {id: {id, code, type, usage, occupied, capacity, available, ..., other params}}</span>
<span class="sd">            Parameters:</span>
<span class="sd">                id, code, type, usage, occupied, capacity: t4.clinical.location fields</span>
<span class="sd">                occupied: calculated as &#39;patients found as moved in and not moved out&#39;</span>
<span class="sd">                available: calculated as &#39;location capacity&#39; - &#39;patients found as moved in and not moved out&#39;</span>
<span class="sd">                patient_ids: calculated as &#39;ids of patients found as moved in and not moved out&#39;</span>
<span class="sd">                </span>
<span class="sd">        Arguments:</span>
<span class="sd">           location_ids=[], types=[], usages=[], </span>
<span class="sd">           codes=[], pos_ids=[], patient_ids=[]: unlimited lists of values semantically corresponding to the parameter name</span>
<span class="sd">           occupied_range=[], capacity_range=[], available_range=[]: min,max ranges of corresponding values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># assertions needed because string is taken as list too, and passing string we may end up with:</span>
        <span class="c"># &quot;where field in (s,t,r,i,n,g)&quot; and may miss some results</span>
<span class="c">#         if debug:</span>
<span class="c">#             assert isinstance(location_ids, (list, tuple)) and all([isinstance(i,(int, long)) for i in location_ids]), \</span>
<span class="c">#                 &quot;type = %s, items: %s&quot; % (type(location_ids).__name__, location_ids)</span>
<span class="c">#             assert isinstance(types, (list, tuple)) and all([isinstance(i,(basestring)) for i in types]), \</span>
<span class="c">#                 &quot;type = %s, items: %s&quot; % (type(types).__name__, types)</span>
<span class="c">#             assert isinstance(usages, (list, tuple)) and all([isinstance(i,(basestring)) for i in usages]), \</span>
<span class="c">#                 &quot;type = %s, items: %s&quot; % (type(usages).__name__, usages)            </span>
<span class="c">#             assert isinstance(codes, (list, tuple)) and all([isinstance(i,(basestring)) for i in codes]), \</span>
<span class="c">#                 &quot;type = %s, items: %s&quot; % (type(codes).__name__, codes)  </span>
<span class="c">#             assert isinstance(pos_ids, (list, tuple)) and all([isinstance(i,(int, long)) for i in pos_ids]), \</span>
<span class="c">#                 &quot;type = %s, items: %s&quot; % (type(pos_ids).__name__, pos_ids)   </span>
<span class="c">#             assert isinstance(patient_ids, (list, tuple)) and all([isinstance(i,(int, long)) for i in patient_ids]), \</span>
<span class="c">#                 &quot;type = %s, items: %s&quot; % (type(patient_ids).__name__, patient_ids)   </span>
<span class="c">#             assert isinstance(occupied_range, (list, tuple)) \</span>
<span class="c">#                 and all([isinstance(i,(int, long)) and i&gt;=0 for i in occupied_range]) and len(occupied_range) in [0, 2], \</span>
<span class="c">#                 &quot;type = %s, items: %s&quot; % (type(occupied_range).__name__, occupied_range)      </span>
<span class="c">#             assert isinstance(capacity_range, (list, tuple)) \</span>
<span class="c">#                 and all([isinstance(i,(int, long)) and i&gt;=0 for i in capacity_range]) and len(capacity_range) in [0, 2], \</span>
<span class="c">#                 &quot;type = %s, items: %s&quot; % (type(capacity_range).__name__, capacity_range)                 </span>
<span class="c">#             assert isinstance(available_range, (list, tuple)) \</span>
<span class="c">#                 and all([isinstance(i,(int, long)) and i&gt;=0 for i in available_range]) and len(available_range) in [0, 2], \</span>
<span class="c">#                 &quot;type = %s, items: %s&quot; % (type(available_range).__name__, available_range)                 </span>
                           
        <span class="c">#print &quot;api: map args: location_ids: %s, available_range: %s, usages: %s&quot; % (location_ids,available_range,usages)</span>
        <span class="n">where_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">location_ids</span><span class="p">:</span> <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;location_id in (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">location_ids</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">patient_ids</span><span class="p">:</span> <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;patient_ids &amp;&amp; array[</span><span class="si">%s</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">patient_ids</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">pos_ids</span><span class="p">:</span> <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;pos_id in (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">pos_ids</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">types</span><span class="p">:</span> <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;type in (&#39;</span><span class="si">%s</span><span class="s">&#39;)&quot;</span> <span class="o">%</span> <span class="s">&quot;&#39;,&#39;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">usages</span><span class="p">:</span> <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;usage in (&#39;</span><span class="si">%s</span><span class="s">&#39;)&quot;</span> <span class="o">%</span> <span class="s">&quot;&#39;,&#39;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">usages</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">codes</span><span class="p">:</span> <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;code in (&#39;</span><span class="si">%s</span><span class="s">&#39;)&quot;</span> <span class="o">%</span> <span class="s">&quot;&#39;,&#39;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">codes</span><span class="p">]))</span>                       
        <span class="k">if</span> <span class="n">occupied_range</span><span class="p">:</span> <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;occupied between </span><span class="si">%s</span><span class="s"> and </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">occupied_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">occupied_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">capacity_range</span><span class="p">:</span> <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;capacity between </span><span class="si">%s</span><span class="s"> and </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">capacity_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">capacity_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">available_range</span><span class="p">:</span> <span class="n">where_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;available between </span><span class="si">%s</span><span class="s"> and </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">available_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">available_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="c">#         if data_models: where_list.append(&quot;data_model in (&#39;%s&#39;)&quot; % &quot;&#39;,&#39;&quot;.join(data_models))</span>
<span class="c">#         if states: where_list.append(&quot;state in (&#39;%s&#39;)&quot; % &quot;&#39;,&#39;&quot;.join(states))        </span>
        <span class="n">where_clause</span> <span class="o">=</span> <span class="n">where_list</span> <span class="ow">and</span> <span class="s">&quot;where </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="s">&quot; and &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">where_list</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&quot;&quot;</span>
        <span class="c">#print where_clause     </span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">            with</span>
<span class="s">                move_patient_date as (</span>
<span class="s">                    select </span>
<span class="s">                        max(a.date_terminated) as max_date_terminated,</span>
<span class="s">                        max(termination_seq) as max_termination_seq,</span>
<span class="s">                        m.patient_id</span>
<span class="s">                    from t4_clinical_patient_move m</span>
<span class="s">                    inner join t4_activity a on m.activity_id = a.id</span>
<span class="s">                    where a.state = &#39;completed&#39;</span>
<span class="s">                    group by m.patient_id</span>
<span class="s">                ),</span>
<span class="s">                patient_per_location as (</span>
<span class="s">                    select </span>
<span class="s">                        m.location_id,</span>
<span class="s">                        count(m.patient_id) as patient_qty,</span>
<span class="s">                        array_agg(mpd.patient_id) as patient_ids</span>
<span class="s">                    from t4_clinical_patient_move m</span>
<span class="s">                    inner join t4_activity ma on m.activity_id = ma.id</span>
<span class="s">                    inner join move_patient_date mpd on m.patient_id = mpd.patient_id</span>
<span class="s">                                                        and ma.termination_seq = mpd.max_termination_seq</span>
<span class="s">                    inner join t4_activity sa on sa.data_model=&#39;t4.clinical.spell&#39; and m.patient_id = sa.patient_id</span>
<span class="s">                    --left join t4_activity a on a.location_id </span>
<span class="s">                    where sa.state = &#39;started&#39;</span>
<span class="s">                    group by m.location_id</span>
<span class="s">                ),</span>
<span class="s">                map as (</span>
<span class="s">                    select </span>
<span class="s">                        l.id as location_id,</span>
<span class="s">                        l.code,</span>
<span class="s">                        l.type,</span>
<span class="s">                        l.usage,</span>
<span class="s">                        l.pos_id,</span>
<span class="s">                        ppl.patient_qty as occupied,</span>
<span class="s">                        l.patient_capacity as capacity,</span>
<span class="s">                        coalesce(l.patient_capacity, 0) - coalesce(ppl.patient_qty, 0) as available,</span>
<span class="s">                        ppl.patient_ids as patient_ids</span>
<span class="s">                    from t4_clinical_location l</span>
<span class="s">                    left join patient_per_location ppl on l.id = ppl.location_id</span>
<span class="s">                )</span>
<span class="s">                </span>
<span class="s">            select * from map </span><span class="si">%s</span><span class="s"> &quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">where_clause</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="n">location</span><span class="p">[</span><span class="s">&#39;location_id&#39;</span><span class="p">]:</span> <span class="n">location</span> <span class="k">for</span> <span class="n">location</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">dictfetchall</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">res</span>
        
<span class="c">#     def get_not_palced_patient_ids(self, cr, uid, location_id=None, context=None):</span>
<span class="c">#         # all current patients</span>
<span class="c">#         spell_domain = [(&#39;state&#39;,&#39;=&#39;,&#39;started&#39;)]</span>
<span class="c">#         spell_pool = self.pool[&#39;t4.clinical.spell&#39;]</span>
<span class="c">#         spell_ids = spell_pool.search(cr, uid, spell_domain)</span>
<span class="c">#         spell_patient_ids = [s.patient_id.id for s in spell_pool.browse(cr, uid, spell_ids, context)]</span>
<span class="c">#         # placed current patients</span>
<span class="c">#         placement_domain = [(&#39;activity_id.parent_id.state&#39;,&#39;=&#39;,&#39;started&#39;),(&#39;state&#39;,&#39;=&#39;,&#39;completed&#39;)]</span>
<span class="c">#         location_id and  placement_domain.append((&#39;activity_id.location_id&#39;,&#39;child_of&#39;,location_id))</span>
<span class="c">#         placement_pool = self.pool[&#39;t4.clinical.patient.placement&#39;]</span>
<span class="c">#         placement_ids = placement_pool.search(cr, uid, placement_domain)</span>
<span class="c">#         placed_patient_ids = [p.patient_id.id for p in placement_pool.browse(cr, uid, placement_ids, context)]       </span>
<span class="c">#         patient_ids = set(spell_patient_ids) - set(placed_patient_ids)</span>
<span class="c">#         #import pdb; pdb.set_trace()</span>
<span class="c">#         return list(patient_ids)</span>
</div>
    <span class="k">def</span> <span class="nf">get_patient_spell_activity_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">patient_id</span><span class="p">,</span> <span class="n">pos_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="p">{</span>
                  <span class="s">&#39;patient_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">patient_id</span><span class="p">],</span>
                  <span class="s">&#39;states&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;started&#39;</span><span class="p">],</span>
                  <span class="s">&#39;data_models&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;t4.clinical.spell&#39;</span><span class="p">]</span>
                  <span class="p">}</span>
        <span class="n">pos_id</span> <span class="ow">and</span> <span class="n">domain</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;pos_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">pos_id</span><span class="p">]})</span>
        <span class="c">#import pdb; pdb.set_trace()</span>
        <span class="n">spell_activity_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activity_map</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="o">**</span><span class="n">domain</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">spell_activity_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spell_activity_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;For patient_id=</span><span class="si">%s</span><span class="s"> found more than 1 started spell_activity_ids: </span><span class="si">%s</span><span class="s"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">patient_id</span><span class="p">,</span> <span class="n">spell_activity_id</span><span class="p">))</span>
        <span class="c">#try:</span>
        <span class="k">return</span> <span class="n">spell_activity_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c">#except:</span>
         <span class="c">#   import pdb; pdb.set_trace()</span>

<span class="c">#     def get_patient_last_spell_activity_id(self, cr, uid, patient_id, pos_id=None, context=None):</span>
<span class="c">#         activity_pool = self.pool[&#39;t4.activity&#39;]</span>
<span class="c">#         domain = [(&#39;patient_id&#39;, &#39;=&#39;, patient_id),</span>
<span class="c">#                   (&#39;state&#39;, &#39;=&#39;, &#39;completed&#39;),</span>
<span class="c">#                   (&#39;data_model&#39;, &#39;=&#39;, &#39;t4.clinical.spell&#39;)]</span>
<span class="c">#         if pos_id:</span>
<span class="c">#             domain.append((&#39;pos_id&#39;, &#39;=&#39;, pos_id))</span>
<span class="c">#         spell_activity_id = activity_pool.search(cr, uid, domain, order=&#39;date_terminated desc&#39;, context=context)</span>
<span class="c">#         if not spell_activity_id:</span>
<span class="c">#             return False</span>
<span class="c">#         return spell_activity_id[0]</span>

    <span class="k">def</span> <span class="nf">get_patient_spell_activity_browse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">patient_id</span><span class="p">,</span> <span class="n">pos_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">spell_activity_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_patient_spell_activity_id</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">patient_id</span><span class="p">,</span> <span class="n">pos_id</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">spell_activity_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="s">&#39;t4.activity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">spell_activity_id</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_device_session_activity_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">device_id</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">activity_pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="s">&#39;t4.activity&#39;</span><span class="p">]</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;device_id&#39;</span><span class="p">,</span> <span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="n">device_id</span><span class="p">),</span>
                  <span class="p">(</span><span class="s">&#39;state&#39;</span><span class="p">,</span> <span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="s">&#39;started&#39;</span><span class="p">),</span>
                  <span class="p">(</span><span class="s">&#39;data_model&#39;</span><span class="p">,</span> <span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="s">&#39;t4.clinical.device.session&#39;</span><span class="p">)]</span>
        <span class="n">session_activity_id</span> <span class="o">=</span> <span class="n">activity_pool</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">domain</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session_activity_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">session_activity_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;For device_id=</span><span class="si">%s</span><span class="s"> found more than 1 started device session activity_ids: </span><span class="si">%s</span><span class="s"> &quot;</span> 
                         <span class="o">%</span> <span class="p">(</span><span class="n">device_id</span><span class="p">,</span> <span class="n">session_activity_id</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">session_activity_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c">#     def get_patient_current_location_browse(self, cr, uid, patient_id, context=None):</span>
<span class="c">#         move_pool = self.pool[&#39;t4.clinical.patient.move&#39;]</span>
<span class="c">#         move_domain = [(&#39;patient_id&#39;,&#39;=&#39;,patient_id), (&#39;state&#39;,&#39;=&#39;,&#39;completed&#39;)]</span>
<span class="c">#         # sort parameter includes &#39;id&#39; to resolve situation with equal values in &#39;date_terminated&#39;</span>
<span class="c">#         move = move_pool.browse_domain(cr, uid, move_domain, limit=1, order=&quot;date_terminated desc, id desc&quot;, context=context)</span>
<span class="c">#         location_id = move and move[0].location_id or False</span>
<span class="c">#         return location_id</span>
<span class="c"># </span>
<span class="c">#     def get_patient_current_location_id(self, cr, uid, patient_id, context=None):</span>
<span class="c">#         res = self.get_patient_current_location_browse(cr, uid, patient_id, context)</span>
<span class="c">#         res = res and res.id</span>
<span class="c">#         return res</span>

<span class="c">#     def get_patient_placement_location_browse(self, cr, uid, patient_id, context=None):</span>
<span class="c">#         placement_pool = self.pool[&#39;t4.clinical.patient.placement&#39;]</span>
<span class="c">#         placement_domain = [(&#39;patient_id&#39;,&#39;=&#39;,patient_id), (&#39;state&#39;,&#39;=&#39;,&#39;completed&#39;)]</span>
<span class="c">#         placement = placement_pool.browse_domain(cr, uid, placement_domain, limit=1, order=&quot;date_terminated desc, id desc&quot;, context=context)</span>
<span class="c">#         placement = placement and placement[0]</span>
<span class="c">#         res = placement and placement.location_id or False</span>
<span class="c">#         return res    </span>
<span class="c">#     </span>
<span class="c">#     def get_patient_placement_location_id(self, cr, uid, patient_id, context=None):</span>
<span class="c">#         res = self.get_patient_placement_location_browse(cr, uid, patient_id, context)</span>
<span class="c">#         res = res and res.id</span>
<span class="c">#         return res    </span>

</div>
<div class="viewcode-block" id="t4_clinical_api_adt"><a class="viewcode-back" href="../code.html#api.t4_clinical_api_adt">[docs]</a><span class="k">class</span> <span class="nc">t4_clinical_api_adt</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">AbstractModel</span><span class="p">):</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s">&#39;t4.clinical.api.adt&#39;</span>

    </div>
<span class="k">class</span> <span class="nc">t4_clinical_api_frontend</span><span class="p">(</span><span class="n">orm</span><span class="o">.</span><span class="n">AbstractModel</span><span class="p">):</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s">&#39;t4.clinical.api.frontend&#39;</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">t4clinical_base 1.0.0 documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Ami.tactix4.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>